# Servlet을 누가 호출할까?
## 1. 쓰레드
* 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
* 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
* 쓰레드가 없다면 자바 애플리케이션 실행이 불가능
* 쓰레드는 한번에 하나의 코드 라인만 수행
* 동시 처리가 필요하면 쓰레드를 추가로 생성
  * 프로세스 = 프로그램을 실행
  * 스레드 = 프로그램 내에서 실행되는 최소단위
## 2. 단일요청
  * WAS에 요청이 들어오면
* 휴식하던 쓰레드에 요청을 할당
* servlet이 실행됨
* 응답을 내보냄
## 3. 다중요청 - 하나의 쓰레드 사용
* 앞에서 쓰레드가 사용중이라면
* 앞선 쓰레드가 연산이 다 끝날때까지 기다려야함
* 결국에는 둘다 타임아웃됨

## 4. 다중요청 - 쓰레드 신규 생성
* 앞선 요청1에 의해서 쓰레드 점유중
* 요청2를 해결하기 위해 신규 쓰레드를 생성하여 요청 수행
* 요청이 올 때 마다 쓰레드를 생성.
```
  * 장점 : 
    * 동시 요청을 처리할 수 있다.
    * 리소스(cpu, 메모리)가 허용할 때 까지 처리가능
    * 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작함.
  * 단점:
    * 쓰레드는 생성 비용이 매우 비싸다 -> 고객의 요청이 올 때 마다 쓰레드를 생성하면 응답 속도가 늦어짐
    * 쓰레드는 컨텍스트 스위칭 비용이 발생함(쓰레드1, 쓰레드2간 전환 할 때)
    * 쓰레드 생성에 제한이 없다 -> 고객 요청이 너무 많이 오면 CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있다.
```
## 5. 해결법 - 쓰레드풀
* 미리 리소스에 무리가 가지 않는 선에서 쓰레드를 미리 만들어서 풀에 저장해둠(톰캣은 기본 최대값이 200개임. 변경가능)
* 요청이 올 때 마다 놀고 있는 쓰레드에 요청을 할당하여 요청을 처리함
* 사용이 다 끝난 쓰레드는 쓰레드풀에 다시 반납
* if 쓰레드풀에 쓰레드가 없으면 대기하거나 요청을 거절 할 수 있음.
```
장점:
    * 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(cpu)이 절약되고, 응답시간이 빠르다.
    * 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리 할 수 있다.
```
## 6 실무 팁
* WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread)수이다.
* 이 값을 너무 낮게 설정하면 -> 동시 요청이 많으면 서버 리소스는 여유롭지만 클라이언트는 금방 응답 지연
* 이 값이 너무 높다면 -> 리소스 임계점 초과로 서버가 다운됨
* 장애가 발생하면
  * 클라우드 상황이면 -> 서버부터 늘리고 이후에 튜닝
  * 온프레미스 상황이면 -> 열심히 튜닝
  ### 6.1 쓰레드풀의 적정 숫자
    * 애플리케이션의 로직 복잡도, cpu, 메모리, IO 리소스 상황에 따라 모두 다름
    * 성능 테스트
      * 최대한 실제 서비스와 유사하게 성능 테스트 시도
      * 툴 : 아파치ab, 제이미터, nGrinder

## 7. 핵심
* 멀티 쓰레드에 대한 부분은 WAS가 처리해줌
* 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨.
* 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발
* 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링빈)는 주의해서 사용.